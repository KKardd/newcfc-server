{"version":3,"sources":["../../../src/security/guard/system-auth.guard.ts"],"sourcesContent":["import { CanActivate, ExecutionContext, Injectable } from '@nestjs/common';\n\nimport { CustomException } from '@/exception/custom.exception';\nimport { ErrorCode } from '@/exception/error-code.enum';\nimport { TokenProvider } from '@/security/jwt/token.provider';\n\nexport const SYSTEM_ISS = 'SYSTEM';\n\n@Injectable()\nexport class SystemAuthGuard implements CanActivate {\n  constructor(private readonly tokenProvider: TokenProvider) {}\n\n  async canActivate(context: ExecutionContext): Promise<boolean> {\n    const request = context.switchToHttp().getRequest();\n    const authorization = request.headers['authorization'];\n\n    if (!authorization) {\n      throw new CustomException(ErrorCode.INVALID_TOKEN);\n    }\n\n    const accessToken = /^Bearer (.*)$/.exec(authorization)?.[1];\n\n    if (!accessToken) {\n      throw new CustomException(ErrorCode.INVALID_TOKEN);\n    }\n\n    try {\n      const decoded = await this.tokenProvider.verifyAccessToken(accessToken);\n      request.user = decoded;\n      const iss = request.user.iss;\n\n      if (iss !== SYSTEM_ISS) {\n        throw new CustomException(ErrorCode.INVALID_TOKEN);\n      }\n\n      return true;\n    } catch (error) {\n      const message = error instanceof Error ? error.message : undefined;\n      throw new CustomException(ErrorCode.INVALID_TOKEN, message);\n    }\n  }\n}\n"],"names":["SYSTEM_ISS","SystemAuthGuard","canActivate","context","request","switchToHttp","getRequest","authorization","headers","CustomException","ErrorCode","INVALID_TOKEN","accessToken","exec","decoded","tokenProvider","verifyAccessToken","user","iss","error","message","Error","undefined","constructor"],"mappings":";;;;;;;;;;;IAMaA,UAAU;eAAVA;;IAGAC,eAAe;eAAfA;;;wBAT6C;iCAE1B;+BACN;+BACI;;;;;;;;;;AAEvB,MAAMD,aAAa;AAGnB,IAAA,AAAMC,kBAAN,MAAMA;IAGX,MAAMC,YAAYC,OAAyB,EAAoB;QAC7D,MAAMC,UAAUD,QAAQE,YAAY,GAAGC,UAAU;QACjD,MAAMC,gBAAgBH,QAAQI,OAAO,CAAC,gBAAgB;QAEtD,IAAI,CAACD,eAAe;YAClB,MAAM,IAAIE,gCAAe,CAACC,wBAAS,CAACC,aAAa;QACnD;QAEA,MAAMC,cAAc,gBAAgBC,IAAI,CAACN,gBAAgB,CAAC,EAAE;QAE5D,IAAI,CAACK,aAAa;YAChB,MAAM,IAAIH,gCAAe,CAACC,wBAAS,CAACC,aAAa;QACnD;QAEA,IAAI;YACF,MAAMG,UAAU,MAAM,IAAI,CAACC,aAAa,CAACC,iBAAiB,CAACJ;YAC3DR,QAAQa,IAAI,GAAGH;YACf,MAAMI,MAAMd,QAAQa,IAAI,CAACC,GAAG;YAE5B,IAAIA,QAAQlB,YAAY;gBACtB,MAAM,IAAIS,gCAAe,CAACC,wBAAS,CAACC,aAAa;YACnD;YAEA,OAAO;QACT,EAAE,OAAOQ,OAAO;YACd,MAAMC,UAAUD,iBAAiBE,QAAQF,MAAMC,OAAO,GAAGE;YACzD,MAAM,IAAIb,gCAAe,CAACC,wBAAS,CAACC,aAAa,EAAES;QACrD;IACF;IA9BAG,YAAY,AAAiBR,aAA4B,CAAE;aAA9BA,gBAAAA;IAA+B;AA+B9D"}