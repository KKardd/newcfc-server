{"version":3,"sources":["../../../src/security/guard/user-role.guard.ts"],"sourcesContent":["import { CanActivate, ExecutionContext, Injectable } from '@nestjs/common';\nimport { Reflector } from '@nestjs/core';\n\nimport { Request } from 'express';\n\nimport { CustomException } from '@/exception/custom.exception';\nimport { ErrorCode } from '@/exception/error-code.enum';\nimport { UserAccessTokenPayload } from '@/security/jwt/token.payload';\n\n@Injectable()\nexport class UserRolesGuard implements CanActivate {\n  constructor(private reflector: Reflector) {}\n\n  canActivate(context: ExecutionContext): boolean {\n    const requiredRoles = this.reflector.get<string[]>('roles', context.getHandler());\n\n    if (!requiredRoles) {\n      throw new CustomException(ErrorCode.INVALID_TOKEN);\n    }\n\n    const request: Request & { user: { payload: UserAccessTokenPayload } } = context.switchToHttp().getRequest();\n    const user = request.user;\n\n    const hasRole = requiredRoles.some((role) => user.payload.roles.some((TenantUserRole) => TenantUserRole === role));\n\n    if (!hasRole) {\n      throw new CustomException(ErrorCode.FORBIDDEN_ROLE);\n    }\n\n    return true;\n  }\n}\n"],"names":["UserRolesGuard","canActivate","context","requiredRoles","reflector","get","getHandler","CustomException","ErrorCode","INVALID_TOKEN","request","switchToHttp","getRequest","user","hasRole","some","role","payload","roles","TenantUserRole","FORBIDDEN_ROLE","constructor"],"mappings":";;;;+BAUaA;;;eAAAA;;;wBAV6C;sBAChC;iCAIM;+BACN;;;;;;;;;;AAInB,IAAA,AAAMA,iBAAN,MAAMA;IAGXC,YAAYC,OAAyB,EAAW;QAC9C,MAAMC,gBAAgB,IAAI,CAACC,SAAS,CAACC,GAAG,CAAW,SAASH,QAAQI,UAAU;QAE9E,IAAI,CAACH,eAAe;YAClB,MAAM,IAAII,gCAAe,CAACC,wBAAS,CAACC,aAAa;QACnD;QAEA,MAAMC,UAAmER,QAAQS,YAAY,GAAGC,UAAU;QAC1G,MAAMC,OAAOH,QAAQG,IAAI;QAEzB,MAAMC,UAAUX,cAAcY,IAAI,CAAC,CAACC,OAASH,KAAKI,OAAO,CAACC,KAAK,CAACH,IAAI,CAAC,CAACI,iBAAmBA,mBAAmBH;QAE5G,IAAI,CAACF,SAAS;YACZ,MAAM,IAAIP,gCAAe,CAACC,wBAAS,CAACY,cAAc;QACpD;QAEA,OAAO;IACT;IAnBAC,YAAY,AAAQjB,SAAoB,CAAE;aAAtBA,YAAAA;IAAuB;AAoB7C"}