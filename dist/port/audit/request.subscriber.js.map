{"version":3,"sources":["../../../src/port/audit/request.subscriber.ts"],"sourcesContent":["import { EntityManager, EventSubscriber, InsertEvent, UpdateEvent } from 'typeorm';\n\nimport { BaseEntity } from '@/domain/entity/base.entity';\nimport { RequestContext } from '@/port/audit/request-context.middleware';\n\n@EventSubscriber()\nexport class RequestSubscriber {\n  constructor(private entityManager: EntityManager) {}\n\n  beforeInsert(event: InsertEvent<BaseEntity>) {\n    const request = this.getRequestFromContext();\n    if (request != null && request.user != undefined) {\n      event.entity.createdBy = request.user.payload.userId;\n      event.entity.updatedBy = request.user.payload.userId;\n    } else {\n      event.entity.createdBy = 0;\n      event.entity.updatedBy = 0;\n    }\n  }\n\n  beforeUpdate(event: UpdateEvent<BaseEntity>) {\n    const request = this.getRequestFromContext();\n\n    if (event.entity) {\n      if (request != null && request.user != undefined) {\n        event.entity.updatedBy = request.user.payload.userId;\n      } else {\n        event.entity.createdBy = 0;\n        event.entity.updatedBy = 0;\n      }\n      event.entity.updatedAt = new Date();\n    }\n  }\n\n  private getRequestFromContext() {\n    const request = RequestContext.getRequest();\n    if (!request) {\n      return null;\n    }\n    return request;\n  }\n}\n"],"names":["RequestSubscriber","beforeInsert","event","request","getRequestFromContext","user","undefined","entity","createdBy","payload","userId","updatedBy","beforeUpdate","updatedAt","Date","RequestContext","getRequest","constructor","entityManager"],"mappings":";;;;+BAMaA;;;eAAAA;;;yBAN4D;0CAG1C;;;;;;;;;;AAGxB,IAAA,AAAMA,oBAAN,MAAMA;IAGXC,aAAaC,KAA8B,EAAE;QAC3C,MAAMC,UAAU,IAAI,CAACC,qBAAqB;QAC1C,IAAID,WAAW,QAAQA,QAAQE,IAAI,IAAIC,WAAW;YAChDJ,MAAMK,MAAM,CAACC,SAAS,GAAGL,QAAQE,IAAI,CAACI,OAAO,CAACC,MAAM;YACpDR,MAAMK,MAAM,CAACI,SAAS,GAAGR,QAAQE,IAAI,CAACI,OAAO,CAACC,MAAM;QACtD,OAAO;YACLR,MAAMK,MAAM,CAACC,SAAS,GAAG;YACzBN,MAAMK,MAAM,CAACI,SAAS,GAAG;QAC3B;IACF;IAEAC,aAAaV,KAA8B,EAAE;QAC3C,MAAMC,UAAU,IAAI,CAACC,qBAAqB;QAE1C,IAAIF,MAAMK,MAAM,EAAE;YAChB,IAAIJ,WAAW,QAAQA,QAAQE,IAAI,IAAIC,WAAW;gBAChDJ,MAAMK,MAAM,CAACI,SAAS,GAAGR,QAAQE,IAAI,CAACI,OAAO,CAACC,MAAM;YACtD,OAAO;gBACLR,MAAMK,MAAM,CAACC,SAAS,GAAG;gBACzBN,MAAMK,MAAM,CAACI,SAAS,GAAG;YAC3B;YACAT,MAAMK,MAAM,CAACM,SAAS,GAAG,IAAIC;QAC/B;IACF;IAEQV,wBAAwB;QAC9B,MAAMD,UAAUY,wCAAc,CAACC,UAAU;QACzC,IAAI,CAACb,SAAS;YACZ,OAAO;QACT;QACA,OAAOA;IACT;IAjCAc,YAAY,AAAQC,aAA4B,CAAE;aAA9BA,gBAAAA;IAA+B;AAkCrD"}